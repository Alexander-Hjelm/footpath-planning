\documentclass{kththesis}

\usepackage{csquotes} % Recommended by biblatex
\usepackage[style=numeric,sorting=none,backend=biber]{biblatex}
\addbibresource{references.bib} % The file containing our references, in BibTeX format

\title{Quality Assesment of OpenStreetMap Footpath Data for 3D City Recreation}
\alttitle{Kvalitetiv undersökning av OpenStreetMaps gångvägsdata för stadsmodellering i 3D}
\author{Alexander Hjelm}
\email{aljhelm@kth.se}
\supervisor{Christopher Peters}
\examiner{Jonas Beskow}
%\hostcompany{Företaget AB} % Remove this line if the project was not done at a host company
\programme{Master in Computer Science}
\school{School of Electrical Engineering and Computer Science}
\date{\today}

\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage[colorinlistoftodos]{todonotes}
\usepackage{float}
\usepackage{hyperref}
\usepackage{multicol}
\usepackage[ruled,vlined]{algorithm2e}
\usepackage{caption}

\setlength\parindent{0pt}
\setlength{\parskip}{1em}
\setcounter{tocdepth}{2}

% Uncomment the next line to include cover generated at https://intra.kth.se/kth-cover?l=en
% \kthcover{kth-cover.pdf}

\begin{document}

% Frontmatter includes the titlepage, abstracts and table-of-contents
\frontmatter

\titlepage

\begin{abstract}
This project assesses the feasibility of creating a 3D representation of OpenStreetMap (OSM) geodata with the inclusion of pedestrian footpaths, by focusing on OSM road and building data in the Stockholm metropolitan area.

An estimate of the positional accuracy of OSM data has been obtained by comparing OSM positional data to a dataset with a known accuracy, which was obtained from the Swedish National Land Survey.
It was found that the average positional error in the OSM dataset was about 2 meters.
This estimate of the positional error was then used to assess the integrity of the OSM Stockholm road network, by locating critical points where assigning standard widths to the roads would cause collision with other features, and evaluating how many of those points could be eliminated by making ajustments within the found margin of error.

It was found that extending all roads with widths led to collisions between roughly 12\% of all roads in the dataset, and the length of road that intersected with other features was less than 0.1\% of the total road length.
Roughly 80\% of these colliding features, and 99\% of the colliding road by length, could be corrected.
It was found that footpaths were less problematic than other road types (primary, secondary, residential), in terms of feature collisions, and thus should pose no more problems in 3D city reproduction than other road types.

The report concludes with a discussion of the findings of this study, and an assessment of the feasibility of generating city models with pedestrian footpaths in a number of different applications from urban planning tools to videogames.
\end{abstract}

\begin{otherlanguage}{swedish}
  \begin{abstract}
    Träutensilierna i ett tryckeri äro ingalunda en oviktig faktor,
    för trevnadens, ordningens och ekonomiens upprätthållande, och
    dock är det icke sällan som sorgliga erfarenheter göras på grund
    af det oförstånd med hvilket kaster, formbräden och regaler
    tillverkas och försäljas Kaster som äro dåligt hopkomna och af
    otillräckligt.
  \end{abstract}
\end{otherlanguage}

\tableofcontents

% Mainmatter is where the actual contents of the thesis goes
\mainmatter

\chapter{Introduction}

\section{Research question}

This project has dealt with the feasibility of including footpath data when generating 3D representations of OpenStreetMap (OSM) data.
A key issue in creating 3D representations of geodata is that since individual features will be extruded to give them width, situations may arise where the generated 3D meshes are intersecting.

The primary contribution is an \emph{investigation into the rate of collision between map features in OSM}.
A program has taken an OSM dataset of the Stockholm area and assigned each road with standard withds according to swedish regulation.
It has then identified critical areas in the OSM dataset, where the paths are so wide that they collide with existing map features.
It has also identified how many of those areas can in theory be corrected by simple translation of the road vertices, without propagation of collision to other features.
Here, features are defined as the geometrical components that comprise the OSM map.
For the purpose of this report, features will refer mainly to roads and building footprints.

The primary study of the rate of collision between roads and other features, will serve to obtain the following three metrics:

\begin{enumerate}
    \item The number of road features that collide with any other feature (road or building).
    \item The number of road edges that intersect with any other building polygon or road polyline.
    \item The total length in meters of these edges will also be calculated as a measure of the total length of road.
\end{enumerate}

The road features will be categorized according to type, so that the rate of collisions between footpaths and other features can be compared to that of other road types.
OSM mainly makes the distinction between primary, secondary, residential and footpath roads, so this classification will also be used in this report.
The above features will be calculated for each road type separately by summing over each road feature of a certain type.
Following this, an algorithm will find the exact same metrics with regards to how many road features that can in theory be corrected by simple geometrical translation of their vertices.
This will also be preseneted in terms of the number of road features, the number of edges and the total length in meters of remaining colliding road.

For the collision study, see sections 1.3.1 for an implementation overview, 4.2 for a detailed walkthrough of the program implementation, and 5.1 for the results.

The secondary contribution will be an \emph{assesment of the geometrical precision of OSM data} around the Stockholm area.
The positional accuracy will be estimated by comparing feature points between the OSM dataset and a reference dataset.
The positional accuracy will be needed to assess where road collisions occur and whether they can easily be corrected.

The secondary study about geodata precision will primarily serve to obtain an estimate of the positional accuracy of the OSM dataset, in meters.
A number of auxillary metrics will be needed to estimate the domain of error on the positional accuracy, namely the feature completeness and shape accuracy of the OSM dataset.
The completeness of the OSM dataset will be taken as a the number of features are represented in both datasets, as a perentage of the total numer of features in the reference dataset.
Shape accuracy is a measure of polygon similarity that was obtained by comparing polygon turning function between matching features, feature by feature.
See section 5.3 for more details about the shape accuracy measure.

For the positional accuracy study, see sections 1.3.2 for an implementation overview, 4.1 for a walkthrough of the program implementation, and 5.2 for the results.

\section{Implementation overview}

\subsection{Assesment of geodata precision}

The geometrical precision study has been carried out in a number of steps that are all detailed below.
First a feature map was found, which mapped individual features between the OSM dataset and a reference dataset.
A program then took matching building pairs and extracted matching geometrical points after first simplifying the polygons using the Douglas-Peucker algorithm.
Once a set of matching points has been found across the whole dataset, the average distance between them was taken as a measure of the positional accuracy.

Additionally, a number of auxillary calculations were neccessary for this study.
The estimated completeness of the OSM dataset (a measure of how many features are represented in both the OSM dataset and the reference dataset) was calculated as the relative difference in area of all building footprints, between the two datasets.
The completeness is needed to estimate the error boundary of the positional accuracy.
Additionally, the shape accuracy of the OSM dataset has also been calculated and graphed as an extra verification of the similarity between the datasets.

\subsection{Collision study}

For the purpose of the collision study, each road has been assigned a standard width that is in line with Swedish regulations, since in the OSM dataset, roads are represented as simple polylines, lacking width.
In a 3D representation however, it is crucial that each road object has a spacial width in order to be rendered and seen.
After the width assignment, a program has iterated over all features and calculated how many of them that overlap with any other feature, as well as the total length of the road polylines that is intersecting some other feature.
The program has then calculated how many of these colliding features that can be corrected by making adjustments that are within the positional accuracy of the OSM data (As obtained by the previous study in this report: Assessment of Geodata Precision).

\section{Problem constraints}

In this study, when working with OSM geodata, the following assumptions have been made about the dataset to reduce the size of the problem domain:

\begin{enumerate}
    \item The program will not handle terrain features and altitude. It will be assumed that the road mesh can be projected on a flat 2D surface without feature intersection.
    \item It will be assumed that the city map consists of only arterial (primary) roads, secondary roads and footpaths.
    \item It will be assumed that the OSM dataset represents all roads as simple polylines, and building footprints as simple connected polygons. Any other features (such as squares, which are roads represented as polygons) will be omitted from the dataset.
    \item The road network is assumed to be a 2D simple graph. This means that any overlapping roads, such as tunnels and bridges that cross over street-level roads, will be eliminated from the dataset. Any self-connected nodes will also be eliminated from the dataset.
\end{enumerate}

\chapter{Background}

\section{Background of 3D city reproduction}

Procedural modeling of road networks is of interest to the fields of urban planning and urban architecture. In recent years there has been an advent of interactive tools that aid urban planners in placing or generating features of an urban plan, particularly roads and road networks. Procedural and AI solutions that aid the arcitect in a form of human-machine symbiosis.

Procedural city-generation models combine architectural elemets, such as streets, lots, buildings, building facades.
Urban design practises with conventional two-dimenstional deliverables range from delivering neighbourhood designs, urban zoning and building plans, to writing design codes and building ordinances.
The last decade has seen multiple startups in the area of software that aid urban arcitecture. The software uses procedural models to render a city grid based on real-world locations, or generate new user-specified parameters, and allow for varying degrees of manual editing on grid, road, neighbourhood, city block or individual feature level.
Some of the most prominent examples are ArcGIS Pro (made by Esri), CityEngine (made by the startup Procedural, bought by ESRI) and Urban Canvas (made by the startup Synthicity, bought by Autodesk, now defunct).

But such tools are as of today not commonly applied in urbanist practises, due to failures in reflecting the unique workspace of arcitects and their design needs. Urban arcitecture is a social factors, stakeholders. Each arcitect is an actor in a continously developing environment, and affecting that environment in a complex manner through their action.
(Stojanivski, 2020)

In recent years, there have been an advent of tools that extract geodata from OSM and generate 3D representations of real world locations by placing terrain, buildings, roads and other features.
However, freely available such tools seldom include smaller roads and pedestrian footpaths such as walkways, sidewalks or trails.

Additionally, the topic is of interest for 3D content creators in for example the fields of video game design or 3D animation. A trend in these fields is using methods of procedural modeling to create large amounts of 3D content quickly and efficiently, while requiring as little hand modeling as possible. Studios who create large worlds are often interested in solutions that generate large road networks without any hand modeling.
Navigation agents, they might fail navigating when faced with a too narrow path or intersecting obstacles
Using a road network to creates an underlying navmesh

\section{Related work}
When assessing the completeness of geodata, a very common scale is Van Oorts criteria for evaluating the quality of geographical information, which at the time of publication received attention from surveyors and cartographers. (van Oort, 2006) Since then a number of publications have examined slices of geodata from van Oort's criteria. In 2008, (Haklay, 2010) conducted such a study to estimate of the quality of OSM positional geodata in London and England. Since the OSM project started in London it was thought that OSM data in the London metropolitan area would be representative of the highest quality data available, and therefore a good indicator for the whole global OSM dataset. The study was conducted by comparing OSM data to Ordnance Survey datasets. The study showed that the OSM dataset had a rough positional accuracy of 6 meters from the reference dataset. However, at the time of the study, the OSM project had captured roughly 29\% of the area of England, meaning that the data completeness was fairly low.

The next notable study to assess the quality of OSM data was published by (Kunze, 2012). The study applied different methods to assess the completeness of OSM data in two federal states in Germany, mainly by analysing the area difference between the OSM dataset and an administrative dataset. Finally, a notable study in 2013-2014, conducted by researchers from various universities in Norway and Germany (Fan et al, 2014), examined the quality and accuracy in building footprint data of the Munich area, at a time and place where the completeness of the OSM dataset was significantly higher (the results of their study showed that the OSM had captured close to 100\% of all building footprints). At the time Munich was one of the most developed cities in OSM. Their study included an insight in the geometrical calculations neccessary to match features and points between two datasets, and how to reliably calculate the metrics needed for the most important and assessible of van Oorts criteria. Their study revealed that although the feature completeness of OSM was high, some architectural details were missing. The results reveal that the positional accuracy of OSM data at the time was about 4 meters.

\chapter{The geodata used in this project}

For the purpose of this project, the OSM road dataset has been sampled around Stockholm metropolitan area.
To assess and correct path widths and path node locations, the OSM building footprint dataset areound the same area has also been used.
As a reference dataset, the property map from the Swedish National Land Survey was used in comparison with the OSM map.
The reference map is provided by the Swedish University of Agricultural Sciences (SLU), and will be referred to in this report as the SLU map or the SLU dataset.
The SLU map conatins only building and property footprints.
The exact map segments that were extracted were in both cases rectangular boundaries with the following coordinates in WGS84: (N: 59.42, E: 18.15, S: 59.23, W: 17.79).
Both datasets were collcted on March 18th, 2020.

\section{OSM data}

The OSM project is a wiki-like geodatabase based on Volunteered Geographical Information (VGI), meaning anyone can contribute by adding or editing features.
OSM road data and building footprints are commonly obtained by manually tracing features in commercially available satellite images.
Such images have a limit on their resolution which puts a theoretical limit on the accuracy of map features compared to their real-world equivalents (Haklay 2010).
Particularily the high resolution imagery from Bing in 2010 led to an increase in building information in OSM, and the positional error is largely due to the limited resolution in such satellite imagery. (Fan et al, 2014).

\section{SLU data}

The SLU map is maintained by The Swedish National Land Survey (Swedish: Lantmäteriet).
The data is collected by geodetic professionals, by land surveying methods such as GPS or DGNSS positioning, or by reproduction of features from ortophoto or stereo mapping from 3D aerial images.
Building features in the SLU dataset have a position accuracy requirement of 2 meters.
The SLU map contains building features and property limits, but no road data.
The map is updated continously by Lantmäteriet, in conjoncture with the forming or reforming of property.
Whereas OSM is a free service, the SLU map is available to paying customers or for free to students and researchers.
(Lantmäteriet, 2019)

\section{A word on coordinate systems}

The SLU dataset is delivered in the SWEREF 99 TM coordinate system (Lantmäteriet, 2019). SWEREF 99 TM is a projected coordinate system and there is no linear transformation to the WGS 48 system, which OSM uses (OSM 19). The coordinate conversions for this paper were obtained using proj: a Linux commandline application for geospatial coordinate conversion.

\section{Specific geodata preprocessing}

Upon delivery of the OSM dataset, all features that intersect with the user-specified domain are included, with their full geometry.
The SLU map however, is delivered with building footprints cropped to exactly match the query coordinates, meaning that buildings at the edge of the user-specified domain can have cropped geometries.
Any building area outside of the query domain will be excluded.
Since the principles behind what features are delivered and how differ between the datasets, it is neccessary to crop both datasets to ensure that all buildings are complete and have matching candidates in the other set.
Any features that intersect the edge of the rectagular boundary, in both datasets, were therefore excluded from the study.

\chapter{Implementation}

\section{Geodata precision study}

\subsection{Quality criteria}

(Haklay 2010) presents a comprehesive list of 8 accuracy classes when it comes to evaluating the quality of geographic information (van Oorts criteria)

\begin{itemize}
  \item Lineage. This is the historical aspect of the dataset, which concerns the collection process and evolution.
  \item Positional accuracy. This relates the coordinate value of an object in the database to the actual location of the ground in the real world.
  \item Attibute accuracy. In a geographical database, objects are commonly tagged with meta-information. This class assesses how correct those values are.
  \item Logical consistency - This assesses the internal consistency of the dataset. For every dataset there may be internal rules and relationships that objects and features must follow, and this class assesses the degree to which these are adhered to.
  \item Completeness - This assesses the lack of data in a dataset, and the coverage of real-world objects. Objects or features may be missing from a dataset, which reduces its quality.
  \item Semantic accuracy - This links the way in which an object or feature is recorded and represented to how it should be interpreted.
  \item Usage, purpose and constraints - This concerns the validity of the dataset in relation to its purpose and how it is used.
  \item Temporal quality - This assesses the validity of the dataset in relation to real-world changes over time.
\end{itemize}

Other than for the purpose of mentioning various sources or error, this project will focus exclusively on the Positional accuracy, Completeness and Semantic accuracy classes.
The comparison of the OSM and SLU maps will focus on these accuracy classes to determine the error tolerance when manipulating features in the 3D map presentation and the road network generating phase.
Figure \ref{fig:osm-slu-map} shows two segments of the Stockholm map where the OSM and SLU datasets show lower semantic and positional accuracy respectively.

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth,height=0.5\textheight,keepaspectratio]{img_map_compare}
    \caption{Example segments of the Stockholm metropolitan area with unsystematic errors in precision. The SLU building dataset (blue) in superimposed on the OSM dataset (dark gray). The top picture is centered on a city block which shows a semantic mismatching between the two datasets. The whole block consists of only two buildings in the OSM dataset, but is divided into 15 smaller building lots in the SLU dataset. The bottom picture shows 4 smaller buildings whose the positional accuracy is low, due to the buildings being incorrectly scaled, skewed and rotated.}
    \label{fig:osm-slu-map}
\end{figure}

\subsection{Other accuracy criteria}

Let us briefly go over all of van Oorts accuracy criteria that will not be assessed through this study.
Let us see how they could be obtained and assessed for both the OSM and SLU maps, staring with the data lineage.
The lineage aspect of the OSM data is available through the OSM History Viewer, an online debugging tool that lets anyone freely view the change history of individual fetures in a commit history-like fashion.
There is an option for editors to include a personal note with their changesets to include additional details or motivate why a change was made, but there is no guaratee that the data includes any information on the aquisition method used (OSM 2020).
The history aspect of the SLU dataset is not freely available online, but the acquistion method is included in the file metadata on a per-object basis.
Lantmäteriet uses internal codes to specifify the acquistion method, and these codes can be referred to in the product description the accompanies the map files.
As the scope of this project is limited to making a broad comparison of the positional accuracy of the two datasets, only the required positional accuracy as described by the SLU product description will be used.

The attribute accuracy measure is interesting, as both maps use encoded metadata on a per feature basis, the attribute accuracy of the two datasets could be assessed by doing a simple feature comparison and creating a translation table between the two attribute maps.
To the knowledge of the author, this has never been done with specifically these two datasets, at the time of writing.

The temporal accuracy will not be assessed as this projects focuses on comparing a single snapshot of the two datasets at the same point in time, and finally the logical accuracy will not be assessed because the underlying logical relations between features in both maps serve no purpose to this project.

\subsection{Assesment of dataset completeness}

(Fan et al., 2014) used the fraction of the total building area in their reference dataset and the OSM dataset to assess the completeness of OSM data.
The motivation for this is to eliminate semantic differences between both datasets.
A very common example of a semantic error when comparing geographic data is that a large building in one dataset may be segmented into several smaller ones in the other, that is to say a building in one set is represented as an aggreation of mutliple buildings in the other set.
This makes a complete one-to-one object mapping impossible.
Rather, buildings have to be identified as 1:1 (one to one), 1:n (one to many) or 1:0 (one to none) cases, depending on if a building is fully represented in the other dataset, represented as an aggregation of smaller plots, or not found at all.
Figure \ref{fig:building-match-types} shows examples of two buildings that were found in the OSM and SLU datasets as 1:1 and 1:n matches respectively.

Since it is impossible to find a one-to-one feature map for building footprints, using building area as an estimator for completeness is much better than i.e. using the number of buildings or other objects in each dataset.
This project will use the building area in the OSM dataset versus that of the SLU dataset to determine the completeness of OSM building data in the Stockholm area, which will then be used as an argument for how accurate the building correspondence and point proximity measures can be.

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth,height=0.5\textheight,keepaspectratio]{img_building_match}
    \caption{Examples of a 1:1 building match (left), where the sought-after building was found both in the OSM (red) and SLU (blue) datasets, and of a 1:n building match (right), where the sought-after building was represented as one polygon in the OSM (red) dataset, but divided into many smaller lots in the SLU (multicolored) dataset.}
    \label{fig:building-match-types}
\end{figure}

\subsection{Correspondence by building area}

(Fan et al., 2014) further discussed how the relative overlap in building area can be used as an estimate of the building correspondence between datasets.
In this project, relative area overlap was used in order to pair buildings from the two datasets together and create a feature map.
This can only be done in cases where there is not much displacement between OSM building footprints data and the reference data set.
Figure \ref{fig:osm-slu-map} under Section 5 shows a typical comparison between the OSM and SLU datasets.
By eyesight it was determined that the displacement of features is small.

The relative building overlap between the OSM and SLU datasets will be defined as folows, given the footprints of any building in the OSM set ($foot_{OSM}$) and the SLU set ($foot_{SLU}$):
\begin{center}
    $S_{RO}(foot_{OSM}, foot_{SLU}) = \frac{A_{Overlap}}{min(A_{foot_{OSM}}, A_{foot_{SLU}}))}$
\end{center}

The relative overlap may be used to determine building matching relations even when the semantic accuracy is low.
If a large building is represented by a single footprint in one dataset but by several smaller footprints in the other, (Rutzinger et al, 2009) found that if $S_{RO}(foot_{A}, foot_{B}) < 30\%$ for two buildings $A$ and $B$ from different sets, then $A$ and $B$ are highly likely to be separate, neighbouring buildings and not in fact identical.
Therefore it will here be assumed that two buildings are matching candidates if their relative area overlap is greater than 30\%.
If a one-to-many object matching is found, the compound perimeter of the footprints in the many-set will be used when calculating the shape accuracy and finding closest vertices between the polygons.

When calculating the area overlap, it was utilized the fact that multipolygons in geojson are represented with the main, bounding polygon first.
Any subsequent polygons always represent cutouts or crop-outs in the footprint.
When calculating the area of a multipolygon building, the area of the first polygon was therefore taken and subtracted with those of the subsequent polygons.

\subsection{Shape accuracy definition}

The building footprint correspondence will be evaluated using a similarity function that depends on the difference between the turning funcitons of matching building footprints in both datasets.
The turning function was first defined by Arkin et al. (1991), as a method for measuring the similarity of two polygons.
The Turning function $T_c(l)$ measures the cumulative angle of the polygon's counter-clockwise tangent, as a function of the cumulative normalized length l.
This project uses the turning function as it is defined by (Fan et al., 2014).
See figure \ref{fig:turning-function} for a side-by-side comparison of a polygon and its turning function.
For a polygon with vertices ${v_1 ... v_n}$ and line segments ${e_1 ... e_n}$ It is defined as follows.
Fix a starting vertex $v_1$.
The tangent angle at $v_1$ is $\theta_{n,1}$. This is the angle between the neighbouring line segments $e_n$ and $e_1$.
For any $i$ such that $i>1$ and $n<i$, the tangent angle at $v_i$ is recursively defined as:
\begin{center}
    $\theta_{i, i-1} = \theta_{n,1} + \sum^{i}_{k=1} \theta_{k, k-1}$
\end{center}
The turning function has some nice geometric properties, in that it is invariant to both rotation and scaling of the polygon. The function contains no information of the orientation of the polygon, only of the relative angle between successive line segments, thus it does not change under roation. It also measures only the normalized cumulative length, which does not change under scaling.
The similarity of two polygons A and B in terms of their turning function is defined as their distance of their cumulative turning functions:
\begin{center}
    $S_{T}(A, B) = 1 - (\int^{1}_{0} T_{C,A}(l) - T_{C,B}(l) dl)^{1/2}$.
\end{center}
The value range will be $(0 < S_{T} < 1)$, where $S_{T}(A,B) = 1$ if the polygons are identical. 
See figure \ref{fig:turning-function-compare} for a side-by-side comparison of two similar polygons and their turning functions.

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth,height=0.5\textheight,keepaspectratio]{img_turn_function}
    \caption{An example of the turning function of a polygon. The edges, vertices and angle of the initial step of the turning funciton are marked.}
    \label{fig:turning-function}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth,height=0.5\textheight,keepaspectratio]{img_turn_function_diff_filled}
    \caption{An example of the turning functions of two corresponding buildings from the OSM and SLU datasets, with the area between them highlighted.}
    \label{fig:turning-function-compare}
\end{figure}

\subsection{Closest point and point proximity}

The final problem is that even when building polygons have been matched between the two datasets, they may not have one-to-one vertex relationship.
Footprints from different datasets may be formed at a different level of detail.
Problems that arise are e.g. that the vertex counts are dissimilar, or that vertex clusters may be found at different parts of the polygon in the two datasets.
To avoid this effect, key points are extracted using the Douglas-Peucker algorithm (Douglas and Peucker, 1973), to create a simplifed footprint with less points that still retain information about the rough features of the detailed footprint.
The idea behind Douglas-Peucker is to recursively divide a polyline.
It initially marks only the start and end points $(v_0, v_n)$ to be kept, and finds the point $v_i$ in between whose distance is the greatest to the line segment between $v_0$ and $v_n$.
It then recursively refines the line segments $(v_0, v_i)$ and $(v_i, v_n)$, and proceeds to do so until a line segment $(v_j, v_k)$ is found, where every point in between $v_j$ and $v_k$ have a distance to the line segment $(v_j, v_k)$ that is smaller than some resolution $\epsilon$.
Then $v_j$ are added to the simplified polyline, and all nodes in between them are discarded.
See Algorithm 1 for a detailed view.
In either case The Oriented Minimum Bounding Rectangle (OMBR) is calculated for the two polygons.
Finally the OMBR for the OSM building footprint is shifted so that its centroid aligns with the centroid of the OMBR of the SLU building footprint.
Any edges in the simplified footprints that coinside with the OMBR from the same dataset are extracted, and the corresponding points in the original footprints will be matched with each other.

\begin{algorithm}[H]
\SetAlgoLined
\KwResult{Write here the result }
    // Find the point with the maximum distance\;
    $d_{max}$ = 0\;
    $index$ = 0\;
    $end$ = length(PointList)\;
    
    \For{$i$=2 to ($end$-1)}{
        $d$ = perpendicularDistance(PointList[$i$], Line(PointList[1], PointList[$end$]))\;
        \If{$d$ $>$ $d_{max}$} {
            $index$ = $i$\;
            $d_{max}$ = $d$\;
        }
    }

    ResultList = []\;
    
    // If max distance is greater than epsilon, recursively simplify\;
    \eIf{$d_{max}$ $>$ $\epsilon$} {
        // Recursive call\;
        recResults1[] = Douglas-Peucker(PointList[1...$index$], $\epsilon$)\;
        recResults2[] = Douglas-Peucker(PointList[$index$...$end$], $\epsilon$)\;

        // Build the result list\;
        ResultList[] = {recResults1[1...length(recResults1) - 1], recResults2[1...length(recResults2)]}\;
    }{
        ResultList[] = {PointList[1], PointList[$end$]}\;
    }
    \Return{ResultList[]}\;

    \caption{Douglas-Peucker}
\end{algorithm}

Finally, when two building footprints and their vertices have been mapped, we will use the offset of matching vertices as a measure of positional error. The average and variance in vertex spread will be calculated and used to make an assessment of the geometric precision of the OSM dataset, and this precision will further be used to form an upper boundary on geometrical corrections that can be made to the map once it has been imported into the application.

\section{Collision study}

The maximum distance between two features was set to 1 times the positional accuracy, since then there will always be ample room to make changes to any features that would collide with the newly moved nodes, and thus we do not need to worry about feature collisions propagating.
In this implementation, roads of different types were allowed to merge into one another to form common intersections.
To facilitate this, it was neccessary to work with a path-by-path representation of the point data.
When two path share a node with common coordinates, they form an intersection which can be of multiple different types.

The default minimum widths were obtained from (Trafikverket, 20). The standard recommended minimum width for a two-lane road in Sweden is 6.5 meters.
Subsequent visual measurements of a few key locations in the Stockholm area revealed the following minimum way widths:
Table \ref{table:road-widths} shows the minimum and maximum road widths that were found during these measurements, and that will be used in the collision study.

\begin{table}[H]
    \begin{tabular}{lllll}
                      & Footpath & Residential & Secondary & Primary \\
        Minimum width & 2.0 m    & 6.0 m       & 6.5 m     & 8.0 m   \\
        Maximum width & 5.0 m    & 9.0 m       & 10.0 m    & 16.0 m
    \end{tabular}
    \captionof{table}{Standard road widths used for the collision study}
    \label{table:road-widths}
\end{table}

\chapter{Results and metrics}

\section{Road collision study}

For the primary collision study.
Table \ref{table:road-collision} shows the statistics of the collision study, and the number of roads, number of edges and total edge length that showed intersections with other features before road extrusion, by road category.
For footpaths in particular, it was shown that 12.05\% of all roads collide with some other feature after extrusion to the minimum width.
The same was shown to be true for 0.11\% of the road polyline edges and 0.09\% of the total road length.
Table \ref{table:road-collision-corrected} shows the remaining roads, edges and total edges length whose intersections with other features could not be resolved by geometrical translation of a distance smaller than the positional accuracy.
For footpaths this was shown to hold of 0.51\% of all roads, 
The number of road edges and percentage of the total road length that could not be corrected by geometric translation was significantly small.

\begin{table}[H]
    \begin{tabular}{lllll}
                                & Footpath      & Residential  & Secondary   & Primary     \\
        Features, total         & 26473         & 10523        & 3044        & 2756        \\
        Edges, total            & 6382579       & 6612383      & 968420      & 420810      \\
        Edge length, total      & 129984.79 km  & 186089.55 km & 29304.57 km & 16162.95 km \\
        Features, colliding     & 3189          & 1032         & 412         & 456         \\
        Edges, colliding        & 7330          & 2362         & 643         & 824         \\
        Edge length, colliding  & 110.67 km     & 66.18 km     & 9389.30 m   & 20.41 km    \\
        Features, percent       & 12.05 \%      & 9.81 \%      & 13.53 \%    & 16.55 \%    \\
        Edges, percent          & 0.11 \%       & 0.04 \%      & 0.07 \%     & 0.20 \%     \\
        Edge length, percent    & 0.09 \%       & 0.04 \%      & 0.03 \%     & 0.13 \%

    \end{tabular}
    \captionof{table}{The first result table of the collision study. This table shows the amount of features and edges, as well as the cumulative edge length, in total and which are intersecting with any other feature.}
    \label{table:road-collision}
\end{table}

\begin{table}[H]
    \begin{tabular}{lllll}
                                & Footpath      & Residential  & Secondary   & Primary     \\
        Features, colliding     & 134           & 336          & 246         & 277         \\
        Edges, colliding        & 157           & 530          & 306         & 407         \\
        Edge length, colliding  & 3248.73       & 6475.99 m    & 3840.00 m   & 8039.54 m   \\
        Features, percent       & 0.51 \%       & 3.19 \%      & 8.08 \%     & 10.51 \%    \\
        Edges, percent          & 0.00 \%       & 0.00 \%      & 0.03 \%     & 0.09 \%     \\
        Edge length, percent    & 0.00 \%       & 0.00 \%      & 0.01 \%     & 0.05 \%

    \end{tabular}
    \captionof{table}{The second result table of the collision study. This table shows the amount of features and edges, as well as the cumulative edge length, which can be corrected by simple geometric translation.}
    \label{table:road-collision-corrected}
\end{table}

\section{Positional accuracy study}

For the secondary study, the average positional accuracy per building was calculated to roughly 2.06 meters, and this will be taken as an estaimate of the positional accuracy of the OSM dataset.
Table \ref{table:positional-accuracy} shows the estimate in positional accuracy that was obtained from the study.
Figure \ref{fig:bar-plot-positional-accuracy} shows the positional accuracies measured per building as a frequency diagram.

\begin{table}[H]
    \begin{tabular}{lllll}
        $e_{average}$ & $e_{max}$ & $e_{min}$ & $e_{standard deviation}$ \\
        2.0579... & 9.9878... & 0.0 & 1.2464...
    \end{tabular}
    \captionof{table}{The estimated positional accuracy of the OSM dataset: average, max, min and standard deviation}
    \label{table:positional-accuracy}
\end{table}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth,height=0.5\textheight,keepaspectratio]{img_pos_error_plot}
    \caption{The average positional accuracies per building as a frequency diagram.}
    \label{fig:bar-plot-positional-accuracy}
\end{figure}

\section{Secondary metrics}

\subsection{Completeness by building area}

Table \ref{table:num-of-buildings} shows the building coverage of the OSM and SLU datasets in terms of the number of buildings and their total area.
Table \ref{table:num-of-buildings-percent} shows the building coverage of both datasets as perentages.
The area cover of the OSM dataset in relation to the SLU dataset was estimated to 98.18\%. This will be taken as an estimate of the completeness of the OSM dataset.

\begin{table}[H]
    \begin{tabular}{lllll}
        & Total number of buildings & Area cover \\
        OSM & 102755 & 33105023.32... $m^2$ \\
        SLU & 170783 & 33718628.97... $m^2$
    \end{tabular}
    \captionof{table}{Total number of buildings and their cumulative area}
    \label{table:num-of-buildings}
\end{table}

\begin{table}[H]
    \begin{tabular}{lllll}
        & Number of buildings (\%) & Area cover (\%) \\
        OSM & 60.17\% & 98.18\% \\
        SLU & 100.00\% & 100.00\%
    \end{tabular}
    \captionof{table}{Total number of buildings and cumulative area as percentages}
    \label{table:num-of-buildings-percent}
\end{table}

\subsection{Building matching statistics}

Table \ref{table:building-matching} shows how many of the OSM to SLU building matches were found in each category of 1:1, 1:n and 1:0 matches.

\begin{table}[H]
    \begin{tabular}{lllll}
        & 1:0 & 1:1 & 1:n & Total \\
        Match count & 9812   & 81722   & 11221   & 102755 \\
        Percent     & 9.55\% & 79.53\% & 10.92\% & 100\%
    \end{tabular}
    \captionof{table}{The number and percentages of matching buildings between both datasets, ordered by type of correlation (1:0, 1:1 or 1:n)}
    \label{table:building-matching}
\end{table}

\subsection{Shape accuracy statistics}

Figure \ref{fig:bar-plot-similarity} shows the shape similarity measured per building as a frequency diagram.

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth,height=0.5\textheight,keepaspectratio]{img_turning_function_plot}
    \caption{The shape similarities between 1:1 building pairs as a frequency diagram.}
    \label{fig:bar-plot-similarity}
\end{figure}

\chapter{Conclusions and future work}

\section{Quality of the OSM dataset}

One could reasonably assume that Stockholm, being one of the more developed cities in one of the most technologically connected country in the world, would be fairly well mapped in OSM.
Let us take the positional accuracy of the Stockholm area, as obtained by this study, as reprentative of that of major cities in developed countries in the OSM dataset.
Then the positional accuracy has improved by roughly 3.5 meters since the study by (Haklay, 2010), and by roughly 1.5 meters since the study by (Fan et al, 2014).
This of course assumes that the SLU reference dataset is taken as absolute.

The completeness analysis by building area shows that the OSM Stockholm dataset has high completeness in terms of both building area and counted features, in the same level as the study of Munich by (Fan et al, 2014).
The difference in area cover can partially be explained by small utility buildings that are often not represented in the OSM dataset.
Particularily the residential areas in downtown, Stockholm, are characteristic in that each city block consists of a street front and an open, communal compound in the middle, inside of which there are usually a number of small utility buildings such as bicycle garages, toolsheds, refuse rooms and such.
See figure \ref{fig:osm-slu-map-utility-buildings} for an example of an area in stockholm with such characteristics.
These buildings are likely hard to make out and trace on publicly available satellite image data.
They are, according to (Fan et al, 2014) occluded by their surroundings due to shadows or forestry.
This appears to be a large consensus in the field.

The low semantic accuracy has made analysis hard.
The available SLU dataset from Lantmäteriet uses a plot-based subdivision of buildings, whereas OSM uses a subdivision that more closely resembles the actual building footprint as seen from above.
In many cases whole city blocks are represented as single buildings, which means that many less meaningful feature matches can be found.
As seen in table \ref{table:building-matching}, about 80\% of all OSM features were found to have a 1:1 mapping to the SLU dataset, but upon further visual comparison it can be seen that many of the 1:n matches are found in a very specified area, namely the residential areas in downtown, Stockholm.
This is problematic since this typical area with the same level of accessibility was likely measured with the same measuring technique, and the unsystematic positional error will likely be similar in these areas.
The question is wether it comforms well to the positional error in the rest of the dataset or not.
This analysis will not be carried out in this project, but could be a good subject for a future master's thesis project.

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth,height=0.5\textheight,keepaspectratio]{img_map_utility_buildings}
    \caption{A map segment which shows an area with many small utility buildings that are represented in the SLU dataset but not in the OSM dataset.}
    \label{fig:osm-slu-map-utility-buildings}
\end{figure}

% Wednesday:
% TODO: Merge 2.1, 2.2
% TODO: 2.1: Add a sentence about where the question fits into the big picture
% TODO: 2.1: Add section refereces to implementation and results of the sub-questions

% Thursday:
% TODO: Verify that citings look correct (compare to other reports)
% TODO: Abstract: Mention that the scientific study is a contribution
% TODO: Main challenge: How to reconstruct a 3D city. Make this more clear in the abstract
% TODO: Introduction (See meeting log for suggestions)
% TODO: Introduction, picture of a virtual city

% Scietific study
% TODO: Find papers and topics for the scientific study (Building footprints, building heights, LOD levels)
% TODO: Read through Todor's recommended papers
% TODO: Scientific study, show how my work integrates in the 3D city reconstruction process.
    % TODO: A lot of the metrics I've used applyg for building accuracy as well (Fan)
    % TODO: Scientific study: Potential application: A method of generating cities on the cheap
% TODO: Scientific study: A set of recommendations. 

% After next meeting with Chris
% TODO: Figure detailing the steps in the point-matching algorithm
% TODO: Edge distance algorithm, outline, algorithm + picture
% TODO: Spell check
% TODO: Go over report one final time
% TODO: Swedish abstract

\section{Collision study}

The immediate conclusion of this study is that, in terms of feature collision, footpaths were not significantly worse than other road categories.
As a result, it can promptly be assumed that city modelling services which already utilize OSM car road data could also use OSM footpath data without a drastic increase in feature collision.
The biggest reason for this is thought to be that footpaths in their nature are narrow.
So narrow in fact that they can be displaced by more than half of their full width (minimum 1 meter) before the limit of half the positional accuracy (1.025 meters) is reached.

Looking closer at the individual collision cases, the next conclusion is that most often it is actually a small part of a road that is colliding, and will need correction.
We make an exemplifying calculation to support this claim.
Looking in tables \ref{table:road-collision} and \ref{table:road-collision-corrected}, we note that before road extrusion, 3189 features and 7330 of their edges are intersecting some other feature.
This means that for each colliding road, on average 2.3 of its edges will be intersecting some other feature, thus bearing responsibility for the collision.
In total there are 26473 feautures and 6382579 edges, meaning that each road feature is on average contructed out of 241 edges.
Thus the percentage of edges colliding per road is on average roughly 0.95\%.
A similar calculation for the number of features that could not be corrected by translation yields that the number of colliding edges per feature is on average 1.2, and that the percentage of colliding edges per feature is 0.49\%.
Visual inspection of the cases where roads collide with other features has supported this.

After visual inspection of the cases where features collide, it was determined that all collision occurences can be almost exclusively classified into one of five categories.
These categories are explained in the list below, and each case is exemplified in figure \ref{fig:collision-cases}.
All these cases will create issues when generating the 3D mesh representation of the city.

\begin{enumerate}
\item Case 1: A building lies in paralel with a road, and the distance between the two is smaller than the minimum width of the road.
\item Case 2: A road shares a node with a building.
\item Case 3: A road is intersecting with certain building features.
\item Case 4: Two roads have a minimum distance that is smaller than the sum of the minimum widths of both roads. 
\item Case 5: Two roads share a node, and a subsequent node in one road lies within the minimum width of the other road.
\end{enumerate}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth,height=0.5\textheight,keepaspectratio]{img_feature_overlap_cases}
    \caption{The 5 identified cases over feature overlap. Top left: Case 1. Top right: Case 2. Middle: Case 3. Bottom left: Case 4. Bottom right: Case 5.}
    \label{fig:collision-cases}
\end{figure}

\section{Suggested algorithms for collision correction}

All collision cases can be solved with relatively simply geometric algorithms. This section will present suggestions on algorithms that will resolve collisions by identifying individual colliding nodes and translating them, after which some degree of smoothing (such as linear interpolation) can be applied to preserve visual features. Cases 1 and 3-5 will be handled, while 2 will be left since case 2 collisions do not inherently cause feature overlap when extruding a 3D road mesh from the way edges. Thus it will me up to the individual developer to decide what to do with Case 2 collisions.

\begin{enumerate}
\item Case 1 collisions can be solved by translating colliding way points away from the building, along the normal of the nearest surface. Smoothing can then be applied as seen fit.
\item Case 3 collisions can be solved by eliminating the building features that intersect with the way, and then applying the same algorithm as in case 1.
\item Case 4 collisions can be solved by calculating the average normal over all colliding edges for both roads, and translating colliding points along the normal, away from the other road. Smoothing can then be applied as seen fit.
\item Case 5 collisions can be solved simply by translating the colliding point along the tangent of the closest edge, and then applying smoothing as seen fit.
\end{enumerate}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth,height=0.5\textheight,keepaspectratio]{img_feature_overlap_fix_1}
    \label{fig:collision-case-1}
    \caption{Example of the solution algorithm for case 1 collision. The yellow line shows the original road placement. The blue line shows the updated road placement. The second picture illustrates how smoothing can be applied to the translated road if desired.}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth,height=0.5\textheight,keepaspectratio]{img_feature_overlap_fix_2}
    \label{fig:collision-case-3}
    \caption{Example of the solution algorithm for case 3 collision. The portruding building feature as seen in \ref{fig:collision-cases} has been eliminated. The yellow line shows the original road placement. The blue line shows the updated road placement.}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth,height=0.5\textheight,keepaspectratio]{img_feature_overlap_fix_3}
    \caption{Example of the solution algorithm for case 4 collision. The yellow lines show the original road placements. The blue lines show the updated road placements. The second picture illustrates how smoothing can be applied to the translated road if desired.}
    \label{fig:collision-case-4}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth,height=0.5\textheight,keepaspectratio]{img_feature_overlap_fix_4}
    \caption{Example of the solution algorithm for case 5 collision. The yellow lines show the original road placements. The blue line segment with the cyan vertex shows the updated placement of the interesting vertex. The remaining blue lines show the boundaries of the original road.}
    \label{fig:collision-case-5}
\end{figure}

\section{Utility in real world applications}


\begin{thebibliography}{9}

\bibitem{arkin-91}
Arkin, Esther \& Chew, L. \& Huttenlocher, Daniel \& Kedem, Klara \& Mitchell, Joseph. (1991). An Efficiently Computable Metric for Comparing Polygonal Shapes. IEEE Transaction Pattern Analysis and Machine Intelligence 13. 209-216.

\bibitem{douglas-peucker-73}
Douglas, D.H. \& Peucker T.K. (1973). Algorithms for the Reduction of the Number of Points Required to Represent a Digitalized Line or Its Caricature. Cartographica: The International Journal for Geographic Information and Geovisualization, 10(2), 112-122.

\bibitem{fan-14}
Fan, Hongchao \& Zipf, Alexander \& Fu, Qing \& Neis, Pascal. (2014). Quality assessment for building footprints data on OpenStreetMap. International Journal of Geographical Information Science. 28. 700-719.

\bibitem{haklay-10}
Haklay, M. (2010). How Good is Volunteered Geographical Information? A Comparative Study of OpenStreetMap and Ordnance Survey Datasets. Environment and Planning B: Planning and Design, 37(4), 682–703.

\bibitem{kunze-12}
Kunze, C. (2012). Vergleichsanalyse des Gebäudedatenbestandes aus OpenStreetMap mit amtlichen Datenquellen. Student research project, Technical University of Dresden. http://nbn-resolving.de/urn:nbn:de:bsz:14-qucosa-88141

\bibitem{lantmateriet-19}
Lantmäteriet. (2019). Produktbeskrivning: GSD-Fastighetskartan vektor. Acessed 16-04-2020.
https://www.lantmateriet.se/globalassets/kartor-och-geografisk-information/kartor/fastshmi.pdf.

\bibitem{osm-19}
OSM. (2019). Converting to WGS84 - OpenStreetMap Wiki. Accessed 13-03-2020.
https://wiki.openstreetmap.org/wiki/Converting\_to\_WGS84.

\bibitem{osm-20}
OSM. (2020). OSM History Viewer - OpenStreetMap Wiki. Accessed 20-03-2020
https://wiki.openstreetmap.org/wiki/OSM\_History\_Viewer.

\bibitem{rutzinger-09}
Rutzinger, M., Rottensteiner, F. and Pfeifer, N. (2009). A Comparison of Evaluation Techniques for Building Extraction From Airborne Laser Scanning. IEEE Journal of Selected Topics in Applied Earth Observations and Remote Sensing 2(1): 11-20.

\bibitem{stojanovski-20}
Stojanovski, T. Partanen J., Samuels I., Sanders, P. and Peters C. (2020, forthcoming). City Information Modelling (CIM) and Digitizing Urban Design Practices. Built Environment.

\bibitem{trafikverket-20}
Trafikverket. (2020). Vägars och gators utformning. Publikation 2020:029. \\
https://trafikverket.ineko.se/Files/sv-SE/71830/ \\
Ineko.Product.RelatedFiles/2020\_029\_vagar\_och\_gators\_utformning\_krav.pdf

\bibitem{van-oort-06}
Van Oort P.A.J. (2006). Spatial Data Quality: From Description to Application. PhD Thesis, Wageningen University.

\end{thebibliography}

\appendix

% Tailmatter inserts the back cover page (if enabled)
\tailmatter

\end{document}
